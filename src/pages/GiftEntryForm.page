<apex:page showHeader="true" 
           standardStylesheets="false" 
           applyBodyTag="false" 
           docType="html-5.0"
           controller="GiftEntryFormController">
    <script src="/soap/ajax/35.0/connection.js" type="text/javascript" />
    <script src="/soap/ajax/35.0/apex.js" type="text/javascript" />
    <script src="/lightning/lightning.out.js" type="text/javascript" />
    <apex:slds />

    <div class="slds-scope">
        <!-- layout=block makes the outputPanel produce a DIV -->
        <apex:outputPanel layout="block" id="giftContainer" rendered="{!hasPerm}"></apex:outputPanel>
        
        <!-- No Access without Profile.PermissionsCustomizeApplication -->
        <apex:outputPanel layout="block" rendered="{!NOT(hasPerm)}">
            <h1 style="font-size: 1.5em;">You do not have permission to create gifts.</h1> 
            <p>Please contact your administrator if you require access.</p>
        </apex:outputPanel>
    </div>

    <script>
        //Because sometimes the session ID is not set correctly
        sforce.connection.sessionId = "{!$Api.Session_ID}";

        // Get the DOM id to load the lightning component into it
        var giftContainerId = document.querySelector('[id$="giftContainer"]').id;
        
        var namespace = '';
        var namespacePrefix = '';
        //This should be a class unique to HEDA so the namespace comes through correctly
        var gettingnamespace = sforce.connection.query("SELECT NamespacePrefix FROM ApexClass where Name = 'GiftEntryForm_CTRL' LIMIT 1");
        var getname = gettingnamespace.getArray("records");
		if(getname.length > 0) { 
		    namespace = getname[0].NamespacePrefix;
		    if(namespace && namespace.length > 0) {
		      namespacePrefix = namespace + '__';
		    }
		}
        if(!namespace || namespace.length === 0) {
            namespace = "c";
        }

        $Lightning.use(namespace + ":giftApp", function() {
            loadComponents(namespacePrefix);
        });
        
        function loadComponents(namespacePrefix) {      
            var recordId = "{!$CurrentPage.parameters.Id}";
            //var recordId = "a0Q11000008a4cwEAA";
            console.log('Id: ' + recordId);

            $Lightning.createComponent(namespace + ":giftEntryForm", 
                {namespacePrefix : namespacePrefix, recordId : recordId}, 
                giftContainerId,
                function(component) {
                    $A.eventService.addHandler({
                        event: 'force:navigateToSObject',
                        handler: function(event) {
                            var recordId = event.getParam('recordId');
                            var view = 'detail';
                            console.log(recordId);
                            if (sforce && sforce.one) {
                                // VF page in Mobile or Lightning
                                sforce.one.navigateToSObject(recordId);
                            } else {
                                // VF page in Classic
                                window.location = '/'+recordId;
                            }
                        }
                    });
                }
            );
        }

    </script>
</apex:page>