<aura:component implements="flexipage:availableForAllPageTypes,force:hasRecordId" access="global" controller="GiftEntryFormController">

    <aura:handler name="init" value="{!this}" action="{!c.doInit}" />
    <aura:handler name="giftPicklistChangeEvent" action="{!c.handlePicklistChange}" event="c:giftPicklistChangeEvent" />
    <aura:handler name="giftMatchChangeEvent" action="{!c.handleMatchChange}" event="c:giftMatchChangeEvent" />
    <aura:dependency resource="markup://force:*" type="EVENT" />

    <aura:attribute name="giftModel" type="GiftEntryFormController.GiftFormModel"/>
    <aura:attribute type="String" name="giftModelString" />
    
    <aura:attribute type="Map" name="objectFieldData" default="{}" />
    <aura:attribute type="Map" name="picklistOptions" />
    <aura:attribute type="Map" name="objectLabels" />
    <aura:attribute type="Object" name="jsonObject" />
    <aura:attribute type="String" name="jsonObjectString" />
    
    <aura:attribute type="String" name="namespacePrefix" />
    <aura:attribute type="String" name="namespaceFieldPrefix" default="" />

    <aura:attribute type="String" name="returnedRecordId" />
    <aura:attribute type="String" name="error" />
    <aura:attribute type="String" name="submitError" />
    <aura:attribute type="String" name="batchId" />
    <aura:attribute type="String" name="picklistNoneText" default="-- None --" />
    <aura:attribute type="String" name="closedStage" default="Closed Won" />
    <aura:attribute type="String" name="oppId" />
    <aura:attribute type="Boolean" name="showForm" default="true" />
    <aura:attribute type="Boolean" name="showSuccess" default="false" />
    <aura:attribute type="Boolean" name="disabled" default="true" />
    <aura:attribute type="Boolean" name="showSpinner" default="false" />
    <aura:attribute type="Boolean" name="showMatchSpinner" default="true" />
    <aura:attribute type="Boolean" name="editMode" default="false" />
    <aura:attribute type="Boolean" name="oppClosed" default="false" />
    <aura:attribute type="Boolean" name="donorExists" default="false" />
    <aura:attribute type="Boolean" name="expandTribute" default="true" />
    <aura:attribute type="Boolean" name="expandMatching" default="true" />
    <aura:attribute type="Boolean" name="messageIsError" default="false" />
    <aura:handler name="change" value="{!v.di.npsp__Donation_Donor__c}" action="{!c.handleDonorTypeChange}"/>
    <aura:handler name="change" value="{!v.donorExists}" action="{!c.handleCheckMatches}"/>

    <!-- Work around for change event on lookups -->
    <aura:handler name="change" value="{!v.di.npsp__Account1Imported__c}" action="{!c.handleLookupChange}"/>
    <aura:handler name="change" value="{!v.di.npsp__Contact1Imported__c}" action="{!c.handleLookupChange}"/>

    <aura:attribute name="di" 
        type="npsp__DataImport__c" 
        default="{sobjectType:'npsp__DataImport__c'}"/>

    <aura:attribute name="opp" 
        type="Opportunity" 
        default="{sobjectType:'Opportunity',CloseDate:null,npe01__Do_Not_Automatically_Create_Payment__c:false}"/>
    <aura:attribute name="payment" 
        type="npe01__OppPayment__c" 
        default="{sobjectType:'npe01__OppPayment__c'}"/>
    <aura:attribute name="acct" 
        type="Account" 
        default="{sobjectType:'Account',Name:'',Phone:''}"/>
    <aura:attribute name="contact" 
        type="Contact" 
        default="{sobjectType:'Contact',FirstName:'',LastName:''}"/>
    
    <aura:attribute name="allocs" 
        type="npsp__Allocation__c[]" 
        default="[]"/>
    <aura:attribute name="payments" 
        type="npe01__OppPayment__c[]" 
        default="[]"/>
    <aura:attribute name="partialCredits" 
        type="npsp__Partial_Soft_Credit__c[]" 
        default="[]"/>
     <aura:attribute name="objsToDelete" 
        type="sObject[]"/>
    

    <aura:if isTrue="{!v.showSpinner}">
        <lightning:spinner />
    </aura:if>

    <div class="slds-card">
        <aura:set attribute="actions">
        </aura:set>

        <aura:if isTrue="{!v.error != null}">
            <ui:message title="Error" severity="error">
                {!v.error}
            </ui:message>
        </aura:if>

        <div class="{!v.showForm ? '' : 'slds-hidden'}">

            <div class="slds-grid slds-wrap" aura:id="formWrapper">
            
                <aura:if isTrue="{!v.oppClosed}">     
                    <div class="slds-col slds-size_1-of-1">
                        <div class="slds-notify slds-notify_alert slds-theme_alert-texture slds-theme_warning" role="alert">
                            <h2>{!$Label.c.Gift_Donation_Locked}</h2>
                        </div>
                    </div>
                </aura:if>

                <lightning:button label="Test JSON" 
                    onclick="{!c.clickRunProcess}" />

                <div class="slds-col slds-size_1-of-1">
                    <div class="slds-page-header slds-page-header__title">
                        Donor Information
                    </div>
                </div>

                <div class="slds-col slds-size_1-of-4 slds-p-around_small">
                    <c:giftPicklist picklistValues="[{value:'Account1',label:'Account'},{value:'Contact1',label:'Contact'}]" 
                        fieldLabel="Donor Type" 
                        selectedVal="{!v.di.npsp__Donation_Donor__c}" />
                </div>

                <div class="{!v.di.npsp__Donation_Donor__c != 'Contact1' ? 'slds-wrap slds-grid slds-size_1-of-4' : 'slds-hidden'}">
                    <div class="slds-col slds-size_1-of-1 slds-p-around_small">
                        <label class="show-required slds-form-element__label">
                            {!v.objectFieldData.objectLabels.Opportunity.AccountId}
                        </label>
                        <force:inputField aura:id="accountLookup" 
                            value="{!v.di.npsp__Account1Imported__c}" />
                    </div>
                </div>
                <div class="{!v.di.npsp__Donation_Donor__c != 'Account1' ? 'slds-wrap slds-grid slds-size_1-of-4' : 'slds-hidden'}">
                    <div class="slds-col slds-size_1-of-1 slds-p-around_small">
                        <label class="show-required slds-form-element__label">
                            {!v.objectFieldData.objectLabels.Opportunity.npsp__Primary_Contact__c}
                        </label>
                        <force:inputField aura:id="contactLookup"
                            value="{!v.di.npsp__Contact1Imported__c}" />
                    </div>
                </div>

                <c:giftFormMatchList
                    currentLookupValue="{!v.di.npsp__Account1Imported__c}"
                    inputAuraId="accountLookup"
                    objectType="Account"
                    showMatchSpinner="{!v.showMatchSpinner}"
                    objectList="{!v.giftModel.matchedAccts}"
                    sectionLabel="Account Matches" />

                <c:giftFormMatchList
                    currentLookupValue="{!v.di.npsp__Contact1Imported__c}"
                    inputAuraId="contactLookup"
                    objectType="Contact"
                    showMatchSpinner="{!v.showMatchSpinner}"
                    objectList="{!v.giftModel.matchedContacts}"
                    sectionLabel="Contact Matches" />

                <div class="slds-col slds-size_1-of-1">
                    <div class="slds-page-header slds-page-header__title">
                        Donation Information
                    </div>
                </div>

                <c:giftFormMatchList
                    currentLookupValue="{!v.di.npsp__DonationImported__c}"
                    objectType="Opportunity"
                    showMatchSpinner="{!v.showMatchSpinner}"
                    objectList="{!v.giftModel.matchedOpps}"
                    sectionLabel="Donation Matches" />

                <c:giftFormMatchList
                    currentLookupValue="{!v.payment.Id}"
                    inputAuraId="paymentLookup"
                    fieldsToShow="['npe01__Scheduled_Date__c','npe01__Payment_Amount__c']"
                    objectType="npe01__OppPayment__c"
                    showMatchSpinner="{!v.showMatchSpinner}"
                    objectList="{!v.giftModel.matchedPayments}"
                    sectionLabel="Unpaid Payment Matches" />

                <aura:if isTrue="{!v.payment.Id != null}">
                    <div class="slds-col slds-size_1-of-1 slds-p-around_small">
                        <lightning:button aura:id="paymentButton" 
                            label="Mark as Paid"
                            variant="brand" 
                            onclick="{!c.clickMarkPaymentPaid}" />
                    </div>
                </aura:if>

                <div class="slds-col slds-size_1-of-2 slds-p-around_small">
                    <label class="show-required slds-form-element__label">
                        {!v.objectFieldData.objectLabels.Opportunity.Name}
                    </label>
                    <lightning:input aura:id="requiredField" 
                        required="true"
                        variant="label-hidden"
                        onchange="{!c.handleFieldChange}"
                        value="{!v.di.npsp__Donation_Name__c}" />
                </div>

                <div class="slds-col slds-size_1-of-2 slds-p-around_small">
                    <label class="show-required slds-form-element__label">
                        {!v.objectFieldData.objectLabels.Opportunity.CloseDate}
                    </label>
                    <lightning:input aura:id="requiredField" 
                        required="true"
                        variant="label-hidden"
                        type="date"
                        onchange="{!c.handleFieldChange}"
                        value="{!v.di.npsp__Donation_Date__c}" />
                </div>

                <div class="slds-col slds-size_1-of-2 slds-p-around_small">
                    <c:giftPicklist picklistValues="{!v.objectFieldData.picklistOptions.npsp__Payment_Method__c}" 
                        fieldLabel="{!v.objectFieldData.objectLabels.Payment.npe01__Payment_Method__c}" 
                        selectedVal="{!v.di.npsp__Payment_Method__c}" />
                </div>

                <div class="slds-col slds-size_1-of-2 slds-p-around_small">
                    <label class="show-required slds-form-element__label">
                        {!v.objectFieldData.objectLabels.Opportunity.Amount}
                    </label>
                    <lightning:input aura:id="requiredField"
                        required="true"
                        variant="label-hidden"
                        type="number"
                        formatter="currency" step="0.01"
                        onchange="{!c.handleFieldChange}"
                        value="{!v.di.npsp__Donation_Amount__c}" />
                </div>

                <div class="slds-col slds-size_1-of-2 slds-p-around_small">
                    <c:giftPicklist picklistValues="{!v.objectFieldData.picklistOptions.npsp__Donation_Stage__c}" 
                        fieldLabel="{!v.objectFieldData.objectLabels.Opportunity.StageName}" 
                        selectedVal="{!v.di.npsp__Donation_Stage__c}" />
                </div>

                <div class="slds-col slds-size_1-of-2 slds-p-around_small">
                    <label class="slds-form-element__label">
                        {!v.objectFieldData.objectLabels.Payment.npe01__Check_Reference_Number__c}
                    </label>
                    <lightning:input disabled="{!v.di.npsp__Payment_Method__c != 'Check'}"
                        variant="label-hidden"
                        value="{!v.di.npsp__Payment_Check_Reference_Number__c}" />
                </div>

                <div class="slds-col slds-size_1-of-2 slds-p-around_small">
                    <label class="slds-form-element__label">
                        {!v.objectFieldData.objectLabels.Opportunity.CampaignId}
                    </label>
                    <force:inputField 
                        value="{!v.di.Donation_Primary_Campaign__c}" />
                        <!-- value="{!v.namespaceFieldPrefix+'Donation_Primary_Campaign__c'}" -->
                </div>
                <div class="slds-col slds-size_1-of-2 slds-p-around_small">
                    <label class="slds-form-element__label">
                        {!v.objectFieldData.objectLabels.Opportunity.Description}
                    </label>
                    <lightning:textarea
                        variant="label-hidden"
                        value="{!v.di.npsp__Donation_Description__c}" />
                </div>


                <button class="slds-col slds-size_1-of-1 slds-text-align_left slds-page-header slds-page-header__title" 
                    aria-expanded="true"
                    onclick="{!c.expandTributeSection}">
                    <lightning:icon iconName="utility:chevrondown" 
                        size="x-small"
                        alternativeText="Toggle Tribute Information" />Tribute Information
                </button>

                <div class="{!v.expandTribute == true ? 'slds-wrap slds-grid slds-size_1-of-1' : 'slds-hidden'}">

                    <div class="slds-col slds-size_1-of-2 slds-p-around_small">
                        <c:giftPicklist picklistValues="{!v.objectFieldData.picklistOptions.Donation_Tribute_Type__c}" 
                            fieldLabel="{!v.objectFieldData.objectLabels.Opportunity.npsp__Tribute_Type__c}" 
                            selectedVal="{!v.di.Donation_Tribute_Type__c}" />
                    </div>

                    <div class="slds-col slds-size_1-of-2 slds-p-around_small">
                        <c:giftPicklist picklistValues="{!v.objectFieldData.picklistOptions.Donation_Acknowledgment_Status__c}" 
                            fieldLabel="{!v.objectFieldData.objectLabels.Opportunity.npsp__Acknowledgment_Status__c}" 
                            selectedVal="{!v.di.Donation_Acknowledgment_Status__c}" />
                    </div>

                    <div class="slds-col slds-size_1-of-2 slds-p-around_small">
                        <label class="slds-form-element__label">
                            {!v.objectFieldData.objectLabels.Opportunity.npsp__Honoree_Name__c}
                        </label>
                        <lightning:input
                            variant="label-hidden"
                            value="{!v.di.Donation_Honoree_Name__c}" />
                    </div>
                    <div class="slds-col slds-size_1-of-2 slds-p-around_small">
                        <label class="slds-form-element__label">
                            {!v.objectFieldData.objectLabels.Opportunity.npsp__Honoree_Contact__c}
                        </label>
                        <force:inputField
                            value="{!v.di.Donation_Honoree_Contact__c}" />
                    </div>
                    <div class="slds-col slds-size_1-of-2 slds-p-around_small">
                        <label class="slds-form-element__label">
                            {!v.objectFieldData.objectLabels.Opportunity.npsp__Notification_Recipient_Name__c}
                        </label>
                        <lightning:input
                            variant="label-hidden"
                            value="{!v.di.Notification_Recipient_Name__c}" />
                    </div>
                    <div class="slds-col slds-size_1-of-2 slds-p-around_small">
                        <label class="slds-form-element__label">
                            {!v.objectFieldData.objectLabels.Opportunity.npsp__Notification_Message__c}
                        </label>
                        <lightning:input
                            variant="label-hidden"
                            value="{!v.di.Donation_Notification_Message__c}" />
                    </div>

                </div>


                <button class="slds-col slds-size_1-of-1 slds-text-align_left slds-page-header slds-page-header__title" 
                    aria-expanded="true"    
                    onclick="{!c.expandMatchingSection}">
                    <lightning:icon iconName="{!v.expandMatching == true ? 'utility:chevrondown' : 'utility:chevronright'}" 
                        size="x-small"
                        alternativeText="Toggle Matching Gift Information" />Matching Gift
                </button>

                <div class="{!v.expandMatching == true ? 'slds-wrap slds-grid slds-size_1-of-1' : 'slds-hidden'}">

                <div class="slds-col slds-size_1-of-2 slds-p-around_small">
                    <label class="slds-form-element__label">
                        {!v.objectFieldData.objectLabels.Opportunity.npsp__Matching_Gift_Employer__c}
                    </label>
                    <lightning:input
                        variant="label-hidden"
                        value="{!v.di.Donation_Matching_Gift_Employer__c}" />
                </div>
                <div class="slds-col slds-size_1-of-2 slds-p-around_small">
                    <label class="slds-form-element__label">
                        {!v.objectFieldData.objectLabels.Opportunity.npsp__Matching_Gift_Account__c}
                    </label>
                    <force:inputField 
                        value="{!v.di.Donation_Matching_Gift_Account__c}" />
                </div>
                <div class="slds-col slds-size_1-of-2 slds-p-around_small">
                    <label class="slds-form-element__label">
                        {!v.objectFieldData.objectLabels.Opportunity.npsp__Matching_Gift__c}
                    </label>
                    <force:inputField 
                        value="{!v.di.Donation_Matching_Gift__c}" />
                </div>

                <div class="slds-col slds-size_1-of-2 slds-p-around_small">
                    <c:giftPicklist picklistValues="{!v.objectFieldData.picklistOptions.Donation_Matching_Gift_Status__c}" 
                        fieldLabel="{!v.objectFieldData.objectLabels.Opportunity.npsp__Matching_Gift_Status__c}" 
                        selectedVal="{!v.di.Donation_Matching_Gift_Status__c}" />
                </div>

                </div>

                <c:giftPaymentScheduler sectionTitle="Payment Scheduler"
                    paymentList="{!v.payments}"
                    objsToDelete="{!v.objsToDelete}"
                    rowCmpName="{!v.namespacePrefix+':giftRelatedPayment'}"
                    donationAmt="{!v.di.npsp__Donation_Amount__c}"
                    paymentMethod="{!v.di.npsp__Payment_Method__c}"
                    objectFieldData="{!v.objectFieldData}"
                    giftModel="{!v.giftModel}" />

                <c:giftFormRelated sectionTitle="Soft Credits"
                    itemList="{!v.partialCredits}"
                    objsToDelete="{!v.objsToDelete}"
                    objectName="npsp__Partial_Soft_Credit__c"
                    rowCmpName="{!v.namespacePrefix+':giftRelatedSoftCredit'}"
                    oppField="npsp__Opportunity__c"
                    amtField="npsp__Amount__c"
                    donationAmt="{!v.di.npsp__Donation_Amount__c}"
                    preventAmountSurplus="true"
                    preventAmountDeficit="false"
                    objectFieldData="{!v.objectFieldData}"
                    modelAttribute="partialCredits"
                    buttonTitle="Add New Soft Credit"
                    giftModel="{!v.giftModel}" />

                <c:giftFormRelated sectionTitle="Allocation"
                    itemList="{!v.allocs}"
                    objsToDelete="{!v.objsToDelete}"
                    objectName="npsp__Allocation__c"
                    rowCmpName="{!v.namespacePrefix+':giftRelatedAllocation'}"
                    oppField="npsp__Opportunity__c"
                    amtField="npsp__Amount__c"
                    donationAmt="{!v.di.npsp__Donation_Amount__c}"
                    preventAmountSurplus="true"
                    preventAmountDeficit="false"
                    objectFieldData="{!v.objectFieldData}"
                    modelAttribute="allocs"
                    buttonTitle="Add New Allocation"
                    giftModel="{!v.giftModel}" />

                <aura:if isTrue="{!v.submitError}">
                    <div id="submitError"
                    class="{!v.messageIsError == true 
                        ? 'slds-notify slds-notify_alert slds-theme_alert-texture slds-theme_error' 
                        : 'slds-notify slds-notify_alert slds-theme_alert-texture slds-theme_warning'}" 
                        role="alert">
                        <span class="slds-assistive-text">Submit error</span>
                        <span class="slds-icon_container slds-icon-utility-error slds-m-right_x-small">
                            <lightning:icon iconName="{!v.messageIsError == true 
                                ? 'utility:error' 
                                : 'utility:warning'}" 
                                variant="inverse"
                                size="x-small" />
                        </span>
                        <h2>{!v.submitError}</h2>
                    </div>
                </aura:if>

                <div class="slds-docked-form-footer" style="height: 50px;">
                    <lightning:button aura:id="cancelButton" 
                        label="{!$Label.c.Cancel}"
                        onclick="{!c.clickCancel}" />
                    <lightning:button aura:id="createButton" 
                        label="{!$Label.c.Gift_Create}"
                        variant="brand" 
                        onclick="{!c.clickCreate}" />
                </div>

                <!-- Fields that are hidden from the user, set by code -->
                 <div class="slds-hidden" style="height: 0">
                    <!-- <lightning:input name="jsonInput" aura:id="postProcessJsonField" /> -->
                    <lightning:input aura:id="doDryRun" type="checkbox" checked="false" class="slds-m-bottom_small"
                        label="{!$Label.c.Gift_Show_Matching}" name="doDryRun" />
                    <lightning:input aura:id="oppId" 
                        value="{!v.giftModel.oppId}" />
                    <lightning:input aura:id="paymentLookup" 
                        value="{!v.payment.Id}" />
                </div>
            </div>

        </div>

    </div>

</aura:component>